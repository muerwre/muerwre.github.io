{"_path":"/frontend/webgl/rendering-without-blocking-in-a-worker","_dir":"webgl","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Rendering Without Blocking In A Worker","description":"Rendering items on #canvas in main loop might cause interface freezes, preventing render process from executing properly by flooding execution stack with operations.","excerpt":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Rendering items on #canvas in main loop "},{"type":"element","tag":"span","props":{"className":["highlight"]},"children":[{"type":"text","value":"might cause interface freezes"}]},{"type":"text","value":", preventing render process from executing properly by flooding execution stack with operations."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To handle it properly, we can start separate #worker thread, that will handle rendering in its own event loop, so that won't affect the source tab's event loop."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Workers can have access to "},{"type":"element","tag":"a","props":{"href":"https://developer.mozilla.org/en-US/docs/Glossary/Transferable_objects","rel":["nofollow"]},"children":[{"type":"text","value":"Transferrable Objects"}]},{"type":"text","value":" from main thread by receiving memory address. "},{"type":"element","tag":"span","props":{"className":["highlight"]},"children":[{"type":"text","value":"That's a lot faster than cloning"}]},{"type":"text","value":". In this case "},{"type":"element","tag":"a","props":{"href":"https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap","rel":["nofollow"]},"children":[{"type":"text","value":"ImageBitmap"}]},{"type":"text","value":" is transferrable."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Code for the main thread component:"}]},{"type":"element","tag":"code","props":{"code":"// main.ts\nconst instance = new Worker('./render-worker.ts');\nconst canvas = document.getElementById('view');\n\n// attaching event listener to worker\ninstance.onmessage = (event: MessageEvent) => {\n    const ctx = canvas?.getContext(\"2d\");\n    if (!ctx) {\n        throw new Error(`Can't get 2D context`);\n    }\n    \n    ctx.drawImage(event.data as ImageBitmap, 0, 0);\n}\n\n// sending canvas contents to worker\nconst renderInCanvas = () => {\n    if (!canvas.current) {\n      return;\n    }\n    \n    createImageBitmap(canvas.current).then(image => {\n        instance.postMessage(image, { transfer: [image] })\n    });\n};\n","language":"typescript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// main.ts\nconst instance = new Worker('./render-worker.ts');\nconst canvas = document.getElementById('view');\n\n// attaching event listener to worker\ninstance.onmessage = (event: MessageEvent) => {\n    const ctx = canvas?.getContext(\"2d\");\n    if (!ctx) {\n        throw new Error(`Can't get 2D context`);\n    }\n    \n    ctx.drawImage(event.data as ImageBitmap, 0, 0);\n}\n\n// sending canvas contents to worker\nconst renderInCanvas = () => {\n    if (!canvas.current) {\n      return;\n    }\n    \n    createImageBitmap(canvas.current).then(image => {\n        instance.postMessage(image, { transfer: [image] })\n    });\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Worker code:"}]},{"type":"element","tag":"code","props":{"code":"// render-worker.ts\nexport default () => {\n  self.onmessage = (message: MessageEvent) => {\n    const data = message.data;\n\n    if (!(data instanceof ImageBitmap)) {\n      throw new Error('Received unknown data')\n    }\n\n    // OffscreenCanvas can be set up inside workers\n    const canvas = new OffscreenCanvas(data.width, data.height);\n    const ctx = canvas.getContext(\"2d\");\n\n    if (!ctx) {\n      throw new Error(`Can't get 2D context`);\n    }\n\n    ctx.drawImage(data, 0, 0);\n\n    // That will block execution inside worker for \n    // a couple of seconds\n    doHardRenderingStuffHere(ctx, data.width, data.height);\n\n    // Sending resulting image back to main thread\n    createImageBitmap(canvas).then((image) => {\n      self.postMessage(image, { transfer: [image] });\n    });\n  };\n};\n","language":"typescript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// render-worker.ts\nexport default () => {\n  self.onmessage = (message: MessageEvent) => {\n    const data = message.data;\n\n    if (!(data instanceof ImageBitmap)) {\n      throw new Error('Received unknown data')\n    }\n\n    // OffscreenCanvas can be set up inside workers\n    const canvas = new OffscreenCanvas(data.width, data.height);\n    const ctx = canvas.getContext(\"2d\");\n\n    if (!ctx) {\n      throw new Error(`Can't get 2D context`);\n    }\n\n    ctx.drawImage(data, 0, 0);\n\n    // That will block execution inside worker for \n    // a couple of seconds\n    doHardRenderingStuffHere(ctx, data.width, data.height);\n\n    // Sending resulting image back to main thread\n    createImageBitmap(canvas).then((image) => {\n      self.postMessage(image, { transfer: [image] });\n    });\n  };\n};\n"}]}]}]}]},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Rendering items on #canvas in main loop "},{"type":"element","tag":"span","props":{"className":["highlight"]},"children":[{"type":"text","value":"might cause interface freezes"}]},{"type":"text","value":", preventing render process from executing properly by flooding execution stack with operations."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To handle it properly, we can start separate #worker thread, that will handle rendering in its own event loop, so that won't affect the source tab's event loop."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Workers can have access to "},{"type":"element","tag":"a","props":{"href":"https://developer.mozilla.org/en-US/docs/Glossary/Transferable_objects","rel":["nofollow"]},"children":[{"type":"text","value":"Transferrable Objects"}]},{"type":"text","value":" from main thread by receiving memory address. "},{"type":"element","tag":"span","props":{"className":["highlight"]},"children":[{"type":"text","value":"That's a lot faster than cloning"}]},{"type":"text","value":". In this case "},{"type":"element","tag":"a","props":{"href":"https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap","rel":["nofollow"]},"children":[{"type":"text","value":"ImageBitmap"}]},{"type":"text","value":" is transferrable."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Code for the main thread component:"}]},{"type":"element","tag":"code","props":{"code":"// main.ts\nconst instance = new Worker('./render-worker.ts');\nconst canvas = document.getElementById('view');\n\n// attaching event listener to worker\ninstance.onmessage = (event: MessageEvent) => {\n    const ctx = canvas?.getContext(\"2d\");\n    if (!ctx) {\n        throw new Error(`Can't get 2D context`);\n    }\n    \n    ctx.drawImage(event.data as ImageBitmap, 0, 0);\n}\n\n// sending canvas contents to worker\nconst renderInCanvas = () => {\n    if (!canvas.current) {\n      return;\n    }\n    \n    createImageBitmap(canvas.current).then(image => {\n        instance.postMessage(image, { transfer: [image] })\n    });\n};\n","language":"typescript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// main.ts"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-7c3be1"},"children":[{"type":"text","value":"instance"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"Worker"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"'./render-worker.ts'"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-7c3be1"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"document"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"getElementById"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"'view'"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// attaching event listener to worker"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"instance"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"onmessage"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e21a77"},"children":[{"type":"text","value":"MessageEvent"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-7c3be1"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"?."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"getContext"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"\"2d\""}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"throw"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-4bc0a6"},"children":[{"type":"text","value":"Error"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"`Can't get 2D context`"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"drawImage"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e21a77"},"children":[{"type":"text","value":"ImageBitmap"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-d0dd92"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-d0dd92"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// sending canvas contents to worker"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"renderInCanvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"current"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"current"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"then"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"instance"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"postMessage"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"image"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", { transfer: ["}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"image"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"] })"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    });"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Worker code:"}]},{"type":"element","tag":"code","props":{"code":"// render-worker.ts\nexport default () => {\n  self.onmessage = (message: MessageEvent) => {\n    const data = message.data;\n\n    if (!(data instanceof ImageBitmap)) {\n      throw new Error('Received unknown data')\n    }\n\n    // OffscreenCanvas can be set up inside workers\n    const canvas = new OffscreenCanvas(data.width, data.height);\n    const ctx = canvas.getContext(\"2d\");\n\n    if (!ctx) {\n      throw new Error(`Can't get 2D context`);\n    }\n\n    ctx.drawImage(data, 0, 0);\n\n    // That will block execution inside worker for \n    // a couple of seconds\n    doHardRenderingStuffHere(ctx, data.width, data.height);\n\n    // Sending resulting image back to main thread\n    createImageBitmap(canvas).then((image) => {\n      self.postMessage(image, { transfer: [image] });\n    });\n  };\n};\n","language":"typescript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// render-worker.ts"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-62015d"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"class":"ct-006fd3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-62015d"},"children":[{"type":"text","value":"default"}]},{"type":"element","tag":"span","props":{"class":"ct-006fd3"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"class":"ct-271f8c"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-006fd3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-10f95c"},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"onmessage"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-7c3be1"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"message"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"instanceof"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e21a77"},"children":[{"type":"text","value":"ImageBitmap"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":")) {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"throw"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-4bc0a6"},"children":[{"type":"text","value":"Error"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"'Received unknown data'"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":")"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// OffscreenCanvas can be set up inside workers"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-7c3be1"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"OffscreenCanvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"width"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"height"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-7c3be1"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"getContext"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"\"2d\""}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"throw"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-1c20ca"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-4bc0a6"},"children":[{"type":"text","value":"Error"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-edeace"},"children":[{"type":"text","value":"`Can't get 2D context`"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"drawImage"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-d0dd92"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-d0dd92"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// That will block execution inside worker for "}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// a couple of seconds"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"doHardRenderingStuffHere"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"ctx"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"width"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"height"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-96d91e"},"children":[{"type":"text","value":"// Sending resulting image back to main thread"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"canvas"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"then"}]},{"type":"element","tag":"span","props":{"class":"ct-c9ae5f"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-cc49e5"},"children":[{"type":"text","value":"postMessage"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"image"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":", { transfer: ["}]},{"type":"element","tag":"span","props":{"class":"ct-dd3f27"},"children":[{"type":"text","value":"image"}]},{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"] });"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"    });"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"  };"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b5f9"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-10f95c{color:#C9D1D9}.ct-271f8c{color:#FF7B72}.ct-006fd3{color:#FFA657}.ct-62015d{color:#FF7B72}.ct-d0dd92{color:#79C0FF}.ct-4bc0a6{color:#79C0FF}.ct-e21a77{color:#FFA657}.ct-dd3f27{color:#C9D1D9}.ct-edeace{color:#A5D6FF}.ct-cc49e5{color:#D2A8FF}.ct-1c20ca{color:#FF7B72}.ct-7c3be1{color:#79C0FF}.ct-59b5f9{color:#C9D1D9}.ct-c9ae5f{color:#FF7B72}.ct-96d91e{color:#8B949E}.light .ct-96d91e{color:#93A1A1}.light .ct-c9ae5f{color:#073642}.light .ct-59b5f9{color:#657B83}.light .ct-7c3be1{color:#268BD2}.light .ct-1c20ca{color:#859900}.light .ct-cc49e5{color:#268BD2}.light .ct-edeace{color:#2AA198}.light .ct-dd3f27{color:#268BD2}.light .ct-e21a77{color:#268BD2}.light .ct-4bc0a6{color:#859900}.light .ct-d0dd92{color:#D33682}.light .ct-62015d{color:#859900}.light .ct-006fd3{color:#657B83}.light .ct-271f8c{color:#073642}.light .ct-10f95c{color:#657B83}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:Frontend:WebGL:Rendering without blocking in a Worker.md","_source":"content","_file":"Frontend/WebGL/Rendering without blocking in a Worker.md","_extension":"md"}