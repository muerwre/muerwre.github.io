{"_path":"/docker/wait-for-mysql","_dir":"docker","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Wait For Mysql","description":"wait-for-it.sh doing a great job of waiting for different services to become alive, but on #MacOs #docker is binding port on container start, seconds before #mysql is ready to accept connections","excerpt":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/vishnubob/wait-for-it","rel":["nofollow"]},"children":[{"type":"text","value":"wait-for-it.sh"}]},{"type":"text","value":" doing a great job of waiting for different services to become alive, but on #MacOs #docker is binding port on container start, seconds before #mysql is ready to accept connections"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This script waits for first successful query from database or exits with non-zero status after timeout."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Don't forget to change "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$query"}]},{"type":"text","value":" for the actually working one."}]},{"type":"element","tag":"code","props":{"code":"# Waits for mysql to become actually available\nwait_for_mysql() {\n  query=\"SELECT count(*) FROM users\"\n  \n  timeout=180 # 3 minutes limit\n  i=0\n  \n  while ! docker exec -it \"$1\" mysql --user=\"$2\" --password=\"$3\" -e \"$query\" $4 >/dev/null 2>&1; do\n    sleep 1;\n\n    i=$(($i+1))\n    if [[ ${i} -ge ${timeout} ]]; then\n      echo \"[Error] can't properly query MySQL after ${i} secs\"\n      exit 1;\n    fi\n  done\n}\n\n# usage: wait_for_mysql miin-mysql-dev root password database\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# Waits for mysql to become actually available\nwait_for_mysql() {\n  query=\"SELECT count(*) FROM users\"\n  \n  timeout=180 # 3 minutes limit\n  i=0\n  \n  while ! docker exec -it \"$1\" mysql --user=\"$2\" --password=\"$3\" -e \"$query\" $4 >/dev/null 2>&1; do\n    sleep 1;\n\n    i=$(($i+1))\n    if [[ ${i} -ge ${timeout} ]]; then\n      echo \"[Error] can't properly query MySQL after ${i} secs\"\n      exit 1;\n    fi\n  done\n}\n\n# usage: wait_for_mysql miin-mysql-dev root password database\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"Wait%20for%20redis"},"children":[{"type":"text","value":"Wait for redis"}]}]}]},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/vishnubob/wait-for-it","rel":["nofollow"]},"children":[{"type":"text","value":"wait-for-it.sh"}]},{"type":"text","value":" doing a great job of waiting for different services to become alive, but on #MacOs #docker is binding port on container start, seconds before #mysql is ready to accept connections"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This script waits for first successful query from database or exits with non-zero status after timeout."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Don't forget to change "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$query"}]},{"type":"text","value":" for the actually working one."}]},{"type":"element","tag":"code","props":{"code":"# Waits for mysql to become actually available\nwait_for_mysql() {\n  query=\"SELECT count(*) FROM users\"\n  \n  timeout=180 # 3 minutes limit\n  i=0\n  \n  while ! docker exec -it \"$1\" mysql --user=\"$2\" --password=\"$3\" -e \"$query\" $4 >/dev/null 2>&1; do\n    sleep 1;\n\n    i=$(($i+1))\n    if [[ ${i} -ge ${timeout} ]]; then\n      echo \"[Error] can't properly query MySQL after ${i} secs\"\n      exit 1;\n    fi\n  done\n}\n\n# usage: wait_for_mysql miin-mysql-dev root password database\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a4746c"},"children":[{"type":"text","value":"# Waits for mysql to become actually available"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-16c29b"},"children":[{"type":"text","value":"wait_for_mysql"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"() {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  query="}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\"SELECT count(*) FROM users\""}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  "}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  timeout=180 "}]},{"type":"element","tag":"span","props":{"class":"ct-a4746c"},"children":[{"type":"text","value":"# 3 minutes limit"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  i=0"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  "}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" docker "}]},{"type":"element","tag":"span","props":{"class":"ct-fafd92"},"children":[{"type":"text","value":"exec"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" -it "}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" mysql --user="}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" -e "}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"query"}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"do"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"    sleep 1"}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"    i="}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"$(("}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"i"}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"class":"ct-fd80ab"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"))"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" [[ "}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"i"}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"-ge"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"timeout"}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" ]]"}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":";"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"then"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-fafd92"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":"\"[Error] can't properly query MySQL after "}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"class":"ct-13c195"},"children":[{"type":"text","value":"i"}]},{"type":"element","tag":"span","props":{"class":"ct-3fa576"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"class":"ct-5b5941"},"children":[{"type":"text","value":" secs\""}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-fafd92"},"children":[{"type":"text","value":"exit"}]},{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":" 1"}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"fi"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-f14022"},"children":[{"type":"text","value":"done"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-deb39e"},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a4746c"},"children":[{"type":"text","value":"# usage: wait_for_mysql miin-mysql-dev root password database"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"Wait%20for%20redis"},"children":[{"type":"text","value":"Wait for redis"}]}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-fd80ab{color:#79C0FF}.ct-13c195{color:#C9D1D9}.ct-3fa576{color:#C9D1D9}.ct-fafd92{color:#79C0FF}.ct-f14022{color:#FF7B72}.ct-5b5941{color:#A5D6FF}.ct-deb39e{color:#C9D1D9}.ct-16c29b{color:#D2A8FF}.ct-a4746c{color:#8B949E}.light .ct-a4746c{color:#93A1A1}.light .ct-16c29b{color:#268BD2}.light .ct-deb39e{color:#657B83}.light .ct-5b5941{color:#2AA198}.light .ct-f14022{color:#859900}.light .ct-fafd92{color:#268BD2}.light .ct-3fa576{color:#859900}.light .ct-13c195{color:#268BD2}.light .ct-fd80ab{color:#D33682}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:Docker:Wait for mysql.md","_source":"content","_file":"Docker/Wait for mysql.md","_extension":"md"}